## 三方平台绑定数字身份协议

![img](https://github.com/idhub-did-plus/magicCircleDIDFrontend/blob/master/protocol/sequenceDiagram.png)

- 前置条件
  - 用户已有去中心化数字身份
  - 第三方应用已有去中心化数字身份
  - 第三方应用提供数字身份绑定入口

- 重要角色
  - 第三方应用（Third-party Application）。
  - 资源所有者（Resource Owner），即用户。
  - IDHub后台，即服务提供商用来处理认证和存放用户生成的资源的服务器，以接口的形式返回第三方应用请求的资源。
  - 授权平台，用于展示二维码和初步认证第三方应用身份。

### 一、应用登记

​           第三方应用接入IDHub数字身份需要前往Magic Circle平台进行注册，需要第三方应用提供对第三方应用的说（选填），以太坊地址，主页地址，授权回调地址。

### 二、授权

授权流程

1. 重定向用户以请求其IDHub身份
2. IDHub将用户重定向回第三方应用
3. 第三方应用使用用户的访问令牌访问API

##### 1. 请求用户的IDHub数字身份

```
GET  /jwt/authorize
```

参数：

 `client_id` `String` :必填项，在Magic Circle平台注册时填写的以太坊地址。

 ` redirect_uri ` `String`：授权后回调地址 ，如果不填默认注册时填写的回调地址。

 `sign` `String` :  三方平台使用注册时地址的私钥对网址进行签名,签名后得到byte[]，再进行base64Url编码得到sign值。

签名数据举例如下：

```
http://locahost:8080/jwt/authorize?client_id= 0x1234567&redirect_uri=http://localhost:8080/redirect_uri
```

##### 2. 授权平台展示用于用户登录二维码

​	授权平台对sign值进行ecRecover解析，并将得到的地址与client_id字段的值进行对比，验证签名是否有效。

签名有效的情况下，将获取到的数据发送至IDHub后台，请求获取二维码数据进行展示。对二维码做出展示的同时，需要向IDHub后台轮询APP授权结果。

发送三方应用信息 ：

```
GET  /did/thirdparty/info
```

参数：

`url` `String` ：授权平台网页链接加上三方应用信息

举例：

```
/did/thirdparty/info?url= http://locahost:8080/jwt/authorize?client_id= 0x1234567&redirect_uri=http://localhost:8080/redirect_uri&sign=WDKSJLSLJ
```

返回参数包含uuid用于轮询

轮询授权结果：

```
GET  /did/check
```

参数

`uuid` `String` ：轮询id

##### 3. 后台服务器验证

​	授权服务器验证三方平台注册地址的有效性以及签名的有效性。验证通过则返回二维码数据，由授权平台进行展示；验证失败向前端返回验证失败消息。

二维码中包含数据格式为"did://sign/jwt/*"，\*号表示采用base64url编码的json数据，格式为：

```
{
	"uuid": ""，
	"aud": "0x383hfd80sc745b0a82f4d21e02bafd7df1a0e14",
	"sub": "login|authorization|st|did|archive",		
	"url": "http://locahost:8080/jwt/authorize",
	"rdt": http://locahost:8080/jwt/authorize/v1/did/token/
     // 如果有需要还可以扩充字段
}
```

- `uuid ` `String`：字段为标记用户的唯一id
- `aud` `String`：三方平台的去中心化数字身份，即`client_id`字段的值
- `sub` `String`：本地传递信息的主题
- `url` `String`：IDHub授权平台的地址
- `rdt` `String`：IDHub app 的签名数据需要请求的地址

##### 4. APP扫码签名

​	APP对授权平台提供的二维码扫码后，构造jwt。

​	判断二维码格式did://sign/jwt/**  ，解析数据base64url解码，获取payload中数据，添加`iss`和`exp`字段。然后构造出以下数据进行组装签名,签名部分使用私钥进行签名。

```
// Header
{
  "alg": "ES256k",//所使用的签名算法
  "typ": "JWT"
}
```

```
// Payload

{
	"aud": "0x383hfd80sc745b0a82f4d21e02bafd7df1a0e14",
	"iss": "0x1ddid8f906c745b0a82f4d21e02bafd7df1a0e14",
	"exp": "1560404678",
	"sub": "login|authorization|st|did|archive",
	"url": "http://stplatform.idhub.network",
	"rdt": http://api.stplatform.idhub.network/v1/did/token/,
    “jti”:”第三方平台用户id”
}
```

- `exp` `时间戳`：为有效时间
- `iss` `String`:  当前的数字身份标识

拼接header.payload进行签名，签名数据需要进行base64url编码 

向`rdt`字段的链接发送以下数据

```
{
	"jwt":"[Base64(header.payload.sign)]"
}
```

​	随后，APP将构造好的jwt发送至IDHub后台，经由后台签名后发送至授权平台。

##### 5. IDHub后台签名APP消息

IDHub后台对APP返回的jwt数据进行签名，再进行Base64Url进行编码，返回至轮询请求，

编码数据示例：

```
{"jwt":"","sign":""}
```

##### 6.授权

授权平台轮循到数据跳转到`redirect_uri`指定的跳转网址，并且携带轮询到的授权码，url示例如下：

```
http://localhost:8080/redirect?
  code=WDSLKSDJLD
```

​	第三方应用可从回调地址中获取到授权码,并用于后续操作。



### 三、第三方应用对数字身份的应用

##### 1.数字身份绑定

​	三方应用获取到授权码进行base64url解码，获取解析出的jwt数据中payload部分的iss字段（App钱包地址），

查询地址，如果已经绑定进行的登录的操作，如果没有绑定，将地址与第三方平台账号进行绑定并存储至第三方平台用户中心。

##### 2.其它操作

1. 第三方应用绑定数字身份的钱包地址到第三方应用的账户中，可根据钱包地址进行资金的转入，余额查询等。

2. 第三方应用根据平台需求向IDHub后台申请用户身份信息，IDHub后台根据不同第三方应用的需求返回相应的部分身份信息。

3. 第三方应用申请数字身份数据，token发送至IDHub后台查询数字身份信息

   HTTP请求的header需携带authorization

   ```
      authorization : token
   ```
   
   随后，第三方应用拿到相应的身份数据信息根据需求进行相应的操作。

4. 如需进行凭证的颁发与审核，第三方应用对数字身份进行审核，审核通过调用接口告知IDHub平台颁发claim，审核不通过调用接口告知IDHub平台拒绝颁发，且需要发送对应的拒绝原因。

5. IDHub平台收到第三方应用的凭证信息之后，自动处理claim结果。

   （后续claim版本需要给拒绝颁发claim添加原因字段。由APP进行展示，用户可根据拒绝颁发原因进行新的身份信息更改。)

6. IDHub平台的凭证发行者也需具有特定的数字身份凭证。

7. IDHub app轮询收到第三方应用claim颁发事件之后，在APP中对相应的claim做出展示。

